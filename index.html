<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>1-3 句子跟讀挑戰</title>
<style>
body { font-family: sans-serif; max-width: 600px; margin: auto; text-align: center; padding: 30px 15px; }
#logo { width: 150px; max-width: 80%; margin-bottom: 10px; }
#game-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
#question-number { font-size: 18px; margin-bottom: 10px; }
#question-selector { margin: 20px 0; }
button { padding: 10px 20px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; background-color: #f0f0f0; cursor: pointer; transition: background-color 0.3s; }
button:hover { background-color: #4a90e2; color: #fff; }
.selector-btn { width: 40px; height: 40px; margin: 5px; padding: 0; border-radius: 50%; }
.hidden { display: none; }
.audio-player-container { margin: 10px 0; }
audio { width: 100%; max-width: 500px; margin: 0 auto; display: block; }
.question-text { font-size: 20px; margin-bottom: 10px; font-weight: bold; }
.keywords { font-size: 20px; margin-bottom: 10px; }
#question-controls { margin-top: 20px; }
.record-btns { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
#progress-container { margin-top: 15px; font-size: 16px; }
#progress-bar { width: 100%; background-color: #eee; border-radius: 10px; overflow: hidden; height: 25px; margin-top: 5px; }
#progress-fill { height: 100%; width: 0%; background-color: #4a90e2; text-align: center; color: #fff; line-height: 25px; font-weight: bold; transition: width 0.3s; }
.completed { background-color: #4caf50; color: #fff; }
</style>
</head>
<body>
<img id="logo" src="logo.png" alt="Logo">
<div id="game-title">1-3 句子跟讀挑戰</div>

<div id="nickname-container">
  <div style="font-size:20px; font-weight:bold; margin-bottom:10px;">歡迎挑戰者到來</div>
  <div style="margin-bottom:10px;">請輸入您的姓名</div>
  <input type="text" id="nickname-input" placeholder="您的名字" style="padding:5px 10px; font-size:16px; width:80%; max-width:300px; margin-bottom:15px;">
  <br>
  <button id="start-game-btn">開始挑戰</button>
</div>

<div id="game-container" class="hidden">
  <div id="question-number">第 <span id="current-number">1</span> 題 / 共 10 題</div>
  <div id="question-selector"><strong>題目選擇：</strong></div>
  <div id="question-text" class="question-text"></div>
  <div class="practice-hint">進階練習：看著關鍵字，試著說出句子</div>
  <div id="keywords" class="keywords"></div>
  <button id="toggle-pro-mode">高手模式</button>
  <div class="pro-mode-hint">進入高手模式後 題目與關鍵字都會隱藏</div>
  <div id="question-controls">
    <div class="audio-player-container">
      <audio id="audio-player" controls></audio>
    </div>
    <div class="record-btns">
      <button id="start-btn">開始錄音</button>
      <button id="stop-btn" disabled>停止錄音</button>
    </div>
    <div class="user-audio-container">
      <audio id="user-audio" controls class="hidden"></audio>
      <button id="submit-audio-btn" class="hidden" style="margin-top:10px;">提交錄音</button>
    </div>
  </div>
  <div id="progress-container">
    已完成題目：<span id="completed-list">無</span>
    <div id="progress-bar">
      <div id="progress-fill">0%</div>
    </div>
    <div id="match-status" style="margin-top:10px; font-weight:bold; color:#4a90e2;"></div>
  </div>
</div>

<script src="recorder.js"></script>
<script>
const questions = [
  { audio: "audio/41010301S.mp3", text: "이 도시는 살기 편하지만, 물가가 비싸다는 점이 좀 아쉬워.", keywords: "도시, 살다, 편하다, 물가, 비싸다" },
  { audio: "audio/41010302S.mp3", text: "서울의 가장 큰 특징은 도시인데도 산이 많다는 점이다.", keywords: "서울, 특징, 도시, 산, 많다" },
  { audio: "audio/41010303S.mp3", text: "무엇보다 중요한 것은 내가 그를 사랑한다는 것이야.", keywords: "무엇보다, 중요하다, 나, 그, 사랑하다" },
  { audio: "audio/41010304S.mp3", text: "새로 온 직원의 장점은 손재주가 좋다는 점이다.", keywords: "새로, 직원, 장점, 손재주, 좋다" },
  { audio: "audio/41010305S.mp3", text: "나의 단점은 적극적이지 못하다는 점이다.", keywords: "나, 단점, 적극적, 못하다, 점" },
  { audio: "audio/41010306S.mp3", text: "이 식당은 하루에 손님을 10팀만 받는 것이 특별한 점이다.", keywords: "식당, 하루, 손님, 10팀, 특별하다" },
  { audio: "audio/41010307S.mp3", text: "커피나 차는 몸의 수분을 빼앗는다는 것이 사실일까?", keywords: "커피, 차, 몸, 수분, 빼앗다" },
  { audio: "audio/41010308S.mp3", text: "이 카드는 포인트 적립이 빠르다는 점이 장점이다.", keywords: "카드, 포인트, 적립, 빠르다, 장점" },
  { audio: "audio/41010309S.mp3", text: "한국어의 특징은 높임말이 있다는 점이다.", keywords: "한국어, 특징, 높임말, 있다, 점" },
  { audio: "audio/41010310S.mp3", text: "한국과 대만 날씨의 차이점은 습도가 다르다는 것이에요.", keywords: "한국, 대만, 날씨, 차이점, 습도" }
];

let currentQuestion = 0;
let isProMode = false;
let recorder, audioContext, stream;
let startTime = Date.now();
let completedQuestions = [];

const unit = "41-1-3 句子跟讀挑戰";

const questionText = document.getElementById("question-text");
const keywordsDiv = document.getElementById("keywords");
const currentNumberSpan = document.getElementById("current-number");
const audioPlayer = document.getElementById("audio-player");
const userAudio = document.getElementById("user-audio");
const startBtn = document.getElementById("start-btn");
const stopBtn = document.getElementById("stop-btn");
const proModeBtn = document.getElementById("toggle-pro-mode");
const completedListSpan = document.getElementById("completed-list");
const progressFill = document.getElementById("progress-fill");
const submitBtn = document.getElementById("submit-audio-btn");
const matchStatus = document.getElementById("match-status");

const nicknameContainer = document.getElementById("nickname-container");
const nicknameInput = document.getElementById("nickname-input");
const startGameBtn = document.getElementById("start-game-btn");
const gameContainer = document.getElementById("game-container");

function showQuestion() {
  const q = questions[currentQuestion];
  questionText.textContent = q.text;
  keywordsDiv.textContent = `[${q.keywords}]`;
  currentNumberSpan.textContent = currentQuestion + 1;
  audioPlayer.src = q.audio;
  userAudio.classList.add("hidden");
  userAudio.src = "";
  submitBtn.classList.add("hidden");
  questionText.style.visibility = isProMode ? "hidden" : "visible";
  keywordsDiv.style.visibility = isProMode ? "hidden" : "visible";
  matchStatus.textContent = "";
}

function createQuestionButtons() {
  const selector = document.getElementById("question-selector");
  selector.innerHTML = "<strong>題目選擇：</strong>";
  questions.forEach((_, idx) => {
    const btn = document.createElement("button");
    btn.textContent = idx + 1;
    btn.className = "selector-btn";
    if (completedQuestions.includes(idx+1)) btn.classList.add("completed");
    btn.onclick = () => {
      stopRecordingIfNeeded();
      currentQuestion = idx;
      showQuestion();
    };
    selector.appendChild(btn);
  });
}

proModeBtn.onclick = () => {
  isProMode = !isProMode;
  questionText.style.visibility = isProMode ? "hidden" : "visible";
  keywordsDiv.style.visibility = isProMode ? "hidden" : "visible";
  proModeBtn.textContent = isProMode ? "恢復題目顯示" : "高手模式";
};

startBtn.onclick = async () => {
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const input = audioContext.createMediaStreamSource(stream);
  recorder = new Recorder(input, { numChannels: 1 });
  recorder.record();
  startBtn.disabled = true;
  stopBtn.disabled = false;

  questionText.style.visibility = "hidden";
};

stopBtn.onclick = () => {
  recorder.stop();
  stream.getAudioTracks()[0].stop();

  recorder.exportWAV(blob => {
    userAudio.src = URL.createObjectURL(blob);
    userAudio.classList.remove("hidden");
    submitBtn.classList.remove("hidden");
  });

  startBtn.disabled = false;
  stopBtn.disabled = true;
  if (!isProMode) questionText.style.visibility = "visible";
};

submitBtn.onclick = () => {
  const nickname = nicknameInput.value.trim() || "未輸入";
  const timeSpent = Math.floor((Date.now() - startTime)/1000);

  let dots = 0;
  matchStatus.textContent = "比對中";
  const interval = setInterval(() => {
    dots = (dots + 1) % 4;
    matchStatus.textContent = "比對中" + "·".repeat(dots);
  }, 500);

  submitBtn.classList.add("hidden");

  recognizeSpeech((recognizedText) => {
    clearInterval(interval);
    const target = questions[currentQuestion].text;
    const score = similarity(recognizedText, target);

    if (score >= 70) {
      matchStatus.textContent = `✅ 通過！相似度 ${score.toFixed(2)}%`;
      if (!completedQuestions.includes(currentQuestion+1)) {
        completedQuestions.push(currentQuestion+1);
        updateProgress();
        createQuestionButtons();
        const totalScore = (completedQuestions.length / questions.length) * 100;
        sendToGoogleForm(nickname, unit, totalScore, timeSpent, currentQuestion+1);
      }
    } else {
      matchStatus.textContent = `❌ 未通過，相似度 ${score.toFixed(2)}%，請重新錄音！`;
      userAudio.src = "";
      userAudio.classList.add("hidden");
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  });
};

function stopRecordingIfNeeded() {
  if (recorder && recorder.recording) {
    recorder.stop();
    stream.getAudioTracks()[0].stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }
}

function updateProgress() {
  completedListSpan.textContent = completedQuestions.length ? completedQuestions.join(",") : "無";
  const percent = ((completedQuestions.length / questions.length) * 100).toFixed(0);
  progressFill.style.width = percent + "%";
  progressFill.textContent = percent + "%";
}

function sendToGoogleForm(nickname, unit, score, time, questionNumber) {
  const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSdESq5-zNmGUoR1QoQ-CJAQaroQfdNPKxOiSgeiJH4s_64DRg/formResponse";
  const formData = new FormData();
  formData.append("entry.1082970818", nickname);
  formData.append("entry.851626887", unit);
  formData.append("entry.498226528", score);
  formData.append("entry.532888754", time);
  formData.append("entry.1930371772", questionNumber);
  fetch(formURL, { method: "POST", body: formData, mode: "no-cors" })
    .then(() => console.log("已送出到 Google 表單！"))
    .catch(err => console.error("送出失敗：", err));
}

async function fetchPreviousProgress(nickname) {
  const apiUrl = "https://api.sheetbest.com/sheets/35939562-3d48-4fd0-9f49-689667e539f8";
  const apiKey = "w6rPgNCJ@o3#T#wNUqJr$Wlii53@IvANGznsOWETWo92i#LzHdvW3jj5OELq17-z";

  try {
    const response = await fetch(apiUrl, { headers: { Authorization: `Bearer ${apiKey}` } });
    const data = await response.json();

    const userRecords = data.filter(row => row.nickname === nickname && row.unit === unit);
    const completedSet = new Set();
    userRecords.forEach(row => {
      if (row.questionNumber) completedSet.add(parseInt(row.questionNumber));
    });

    completedQuestions = Array.from(completedSet).sort((a,b)=>a-b);
    updateProgress();

  } catch (err) {
    console.error("讀取先前進度失敗:", err);
  }
}

nicknameInput.onblur = () => {
  const name = nicknameInput.value.trim();
  if (name) fetchPreviousProgress(name);
};

startGameBtn.onclick = () => {
  if (!nicknameInput.value.trim()) {
    alert("請輸入您的姓名");
    return;
  }
  nicknameContainer.classList.add("hidden");
  gameContainer.classList.remove("hidden");
  startTime = Date.now();
  showQuestion();
  createQuestionButtons();
  updateProgress();
};

function similarity(a, b) {
  if (!a || !b) return 0;
  a = a.toLowerCase(); b = b.toLowerCase();
  let same = 0;
  const minLen = Math.min(a.length, b.length);
  for (let i=0;i<minLen;i++) if (a[i]===b[i]) same++;
  return (same / b.length) * 100;
}

function recognizeSpeech(callback) {
  setTimeout(() => {
    const random = Math.random();
    callback(random>0.5 ? questions[currentQuestion].text : "隨機錯誤結果");
  }, 2000);
}
</script>
</body>
</html>
